# witness (server)

This guide gives a short overview of what is necessary to successfully build and run `witness`' server application.

## Prerequisites

* JDK 15
* optional: [Maven](https://maven.apache.org/)

## General

The application uses Maven as build tool and follows common conventions for such projects. The [pom.xml](pom.xml)
contains the dependencies and build customizations such as `checkstyle` goals for static code analysis.

### Development Privileges

In order to successfully run the application, one needs a private key to a Firebase authentication server
(depending on the Spring application profile to activate). For security reasons, they are _not_ checked into the Git
repository. They may only be obtained from trusted project maintainers via a secure channel (e.g. no public chats or
unencrypted emails).

Therefore, all steps below that refer to actually running the application can only be successfully re-enacted if you
have already obtained such a private key.

Currently active keys:

| Description             | Spring Profile | File Path                                       |
|-------------------------|----------------|-------------------------------------------------|
| Development Environment | `development`  | `src/main/resources/auth/private-key-dev.json`  |
| Production Environment  | `production`   | `src/main/resources/auth/private-key-prod.json` |

In principle, every developer may choose any path and name for their private key files. However, for the purpose of a
uniform development experience, it is highly encouraged to stick to the conventions outlined in this guide. This also
enables one to benefit from the ready-made run-configurations included in this repository (see section [Run](#run)
below).

### Running Maven Commands

In the following, Maven commands are represented by command-line invocations of the form `mvn <cmd>`. It is recommended
to have a local installation of Maven in order to follow along. Many IDEs come pre-equipped with a Maven installation
and integrated support for issuing commands.

If, however, it is not an option for you to do so as well (e.g. restricted server environment), you may use the Maven
wrapper instance which is part of this repository (in the form of [mvnw](mvnw) for Unix-like machines
and [mvnw.cmd](mvnw.cmd) for Windows users). If you choose to use this, steps requiring you to issue `mvn <cmd>` will
translate to `./mvnw <cmd>` for you.

You might want to delete artifacts from previous builds prior to executing a desired Maven command. In order to do so,
prefix your command with `clean`, i.e. `mvn <cmd>` becomes `mvn clean <cmd>`.

## Build

The application is built via

```shell
mvn compile
```

## Test

Unit tests are executed with

```shell
mvn test
```

If you also want to verify quality criteria by running integration tests on the packaged code, invoke

```shell
mvn verify
```

### REST API Documentation

The [ApiGenerationTest](src/test/java/com/witness/server/integration/web/ApiGenerationTest.java) class is a special
test. It exploits the Spring `ApplicationContext` provided by the `@SpringBootTest` annotation and extracts
the documentation of the application's REST API which is compliant to [OpenApi 3](https://spec.openapis.org/oas/v3.1.0)
and generated by the `springdoc` dependency based on the annotations employed in controller classes in
the [controller](src/main/java/com/witness/server/web/controller) package).

After a successful execution of the `downloadApiSpecification` test, the documentation is stored as a YAML as well as
a JSON file in the server's root directory. Their contents may be interpreted, visualized and the API interactively
tested by tools with such functionality - e.g. [Swagger Editor](https://editor.swagger.io/) or IntelliJ IDEA.

## Package

The server is packaged into an executable JAR file containing all dependencies with

```shell
mvn package
```

This command also includes the `test` phase of the Maven build lifecycle. If you want to skip that phase, i.e. build
a JAR file without executing tests, you have two options. While with

```shell
mvn package -DskipTests
```

tests get compiled, but not executed,

```shell
mvn package -Dmaven.test.skip
```

neither compiles nor executes tests.

## Run

### Application Configuration

The applications core configuration can be found in [application.yml](src/main/resources/application.yml). Refer to the
documentation of the properties defined there for extensive information on how to properly configure the server app.

There are, however, two properties of special note because their value is crucial for a successful application
execution. In order to achieve the highest flexibility and practicability - especially considering the application runs
in a (Unix)
server environment during production -, the values of these properties are determined by environment variables. Derived
profiles may override that behaviour of course. However, presently, this is neither the case for the `development` nor
the `production` profile.

The table below depicts the properties, their meaning and their corresponding environment variable name.

| Property                                | Description                                                                                                                                                                                                                                                                                                                                                                              | Value (Environment Variable Name) |
|-----------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|
| `security.firebase-service-account-key` | Identifies a `Resource` (`ClassPathResource`, `FileSystemResource`, ...) that represents the private key used to establish a trusted interaction channel with the Firebase server. Find more information on that in Spring's [ResourceLoader documentation](https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/resources.html#resources-resourceloader). | `GOOGLE_APPLICATION_CREDENTIALS`  |
| `check-token-revoked`                   | If `true`, the server will check if a token has been revoked when verifying a request using bearer JWT. Otherwise, revoked tokens are still allowed to be used until their original expiration date. Tokens are valid for one hour by default.                                                                                                                                           | `CHECK_TOKEN_REVOKED`             |

These environment variables need to be properly set in order to successfully run the application.

### Database Setup

When starting the application for the first time, the database needs to be initialized and potentially pre-filled with
some data (e.g. initial exercises, user data which is already present on the Firebase authentications server).

This is done with the help of
the [EnvironmentBootstrapper](src/main/java/com/witness/server/setup/EnvironmentBootstrapper.java) class which is run by
the `setup` profile.

All the data to be inserted into the database need to be configured
in [application-setup.yml](src/main/resources/application-setup.yml). Please refer to the documentation of the
properties.

After populating the profile configuration with the desired data, the application should be run with exactly two
profiles: either `development, setup` or `production, setup`. This invokes the `EnvironmentBootstrapper` and,
afterwards, runs the application normally in development or production mode.

This is done automatically if you use the respective run configuration (see
[IntelliJ Run Configurations](#intellij-run-configurations)). Otherwise, you have to specify the correct environment
variables as well as the spring profiles manually.

Example (equivalent to configuration `ServerApplication-Setup-Prod`):

```shell
export GOOGLE_APPLICATION_CREDENTIALS="classpath:auth/private-prod-dev.json"
export CHECK_TOKEN_REVOKED=true
java -jar -Dspring.profiles.active=production,setup witness.jar
```

After successful database initialization, subsequent application runs do not require the `setup` profile anymore -
environment variables and `development` (or `production`) profile will suffice.

### During Development

Simply use a run configuration provided by the repository. If you are using a different IDE than IntelliJ, you may need
to create your own configuration that appropriately sets the environment variables and active profiles.

### After Packaging

As already shown above in the [Database Setup](#database-setup) section, when running a server application package, you
have to manually set environment variables as well as spring profiles via the command-line:

```shell
export GOOGLE_APPLICATION_CREDENTIALS="file:/root/path-to-witness/private-prod-dev.json"
export CHECK_TOKEN_REVOKED=true
java -jar -Dspring.profiles.active=production /root/path-to-witness/witness.jar
```

Note that the command above uses a `FileSystemResource` (denoted by the `file:` prefix) as well as absolute paths in all
instances. This is desirable for isolated server environments, especially when running the application as a `systemd`
service.

### IntelliJ Run Configurations

In order to ease and unify the way of invoking the server application, the [.run](.run) directory contains run
configurations for IntelliJ IDEA which set Spring Boot profiles and environment variables as required by the application
and as recommended by project conventions.

The table below gives an overview of the ready-made run configurations which are part of the repository.

| Name                           | Purpose                                   | Active Profiles        | `GOOGLE_APPLICATION_CREDENTIALS`       | `CHECK_TOKEN_REVOKED` |
|--------------------------------|-------------------------------------------|------------------------|----------------------------------------|-----------------------|
| `ServerApplication-Dev`        | development environment                   | `development`          | `classpath:auth/private-key-dev.json`  | `true`                |
| `ServerApplication-Prod`       | production environment                    | `production`           | `classpath:auth/private-key-prod.json` | `true`                |
| `ServerApplication-Setup-Dev`  | database setup in development environment | `development`, `setup` | `classpath:auth/private-key-dev.json`  | `true`                |
| `ServerApplication-Setup-Prod` | database setup in production environment  | `production`, `setup`  | `classpath:auth/private-key-prod.json` | `true`                |

## Tools

During development, some tools facilitating common tasks are available.

### Swagger UI

The interactive Swagger UI documenting and enabling tests of the REST API is available
at [http://localhost:8080/swagger-ui/index.html](http://localhost:8080/swagger-ui/index.html).

### H2 Console

The database can be accessed at [http://localhost:8080/h2-console/](http://localhost:8080/h2-console/) while the
application is running. If the application is _not_ running, invoke [run-h2.sh](run-h2.sh) or [run-h2.cmd](run-h2.cmd),
depending on your operating system.

The following settings are required to successfully connect to the database:

* **Saved Settings**: Generic H2 (Embedded)
* **Setting Name**: Generic H2 (Embedded)
* **Driver Class**: `org.h2.Driver`
* **JDBC URL**: `jdbc:h2:file:/path/to/witness/server/database/server-dev` (see also see `spring.datasource.url`
  in [application-development.yml](src/main/resources/application-development.yml))
* **User Name**: see `spring.datasource.username`
  in [application-development.yml](src/main/resources/application-development.yml)
* **Password**: see `spring.datasource.password`
  in [application-development.yml](src/main/resources/application-development.yml)
